<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LinkedIn Callback</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #status { color: green; }
    #error { color: red; }
  </style>
</head>
<body>
  <h2>Processing LinkedIn Login...</h2>
  <div id="status"></div>
  <div id="error"></div>

  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="./firebaseConfig.js"></script>
  <script>
    // Initialize Firebase (ensure firebaseConfig.js is correctly linked)
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');

    function showStatus(msg) {
      statusDiv.textContent = msg;
      errorDiv.textContent = '';
    }

    function showError(msg) {
      errorDiv.textContent = msg;
      statusDiv.textContent = '';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const state = urlParams.get('state');
      const storedState = sessionStorage.getItem('linkedin_oauth_state');

      console.log('linkedin-callback.html: URL state parameter:', state); // DEBUG LOG
      console.log('linkedin-callback.html: Stored state from sessionStorage:', storedState); // DEBUG LOG

      // Basic CSRF protection: Verify the state parameter
      if (state !== storedState) {
        showError("State mismatch. Possible CSRF attack.");
        console.error('State mismatch detected! URL state:', state, 'Stored state:', storedState); // DEBUG LOG
        return;
      }
      sessionStorage.removeItem('linkedin_oauth_state'); // Clear the stored state

      if (code) {
        showStatus("Received LinkedIn authorization code. Sending to backend...");
        console.log('linkedin-callback.html: Authorization code received, attempting to send to backend.'); // DEBUG LOG
        // Send the authorization code to your Django backend
        // This endpoint should match the URL you define in Django (e.g., /api/auth/linkedin-callback/)
        fetch('/api/auth/linkedin-callback/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ code: code, state: state }),
        })
        .then(response => {
          console.log('linkedin-callback.html: Backend response status:', response.status); // DEBUG LOG
          if (!response.ok) {
            return response.json().then(errorData => { throw new Error(errorData.error || 'Unknown backend error'); });
          }
          return response.json();
        })
        .then(data => {
          console.log('linkedin-callback.html: Backend response data:', data); // DEBUG LOG
          if (data.firebase_token) {
            auth.signInWithCustomToken(data.firebase_token)
              .then(userCredential => {
                // --- IMPORTANT CHANGE HERE ---
                // Redirect to index.html with success parameters
                const userId = userCredential.user.uid;
                console.log('Firebase sign-in successful:', userId); // DEBUG LOG
                window.location.href = `/?linkedin_auth_success=true&uid=${userId}`;
              })
              .catch(error => {
                showError("Firebase custom token sign-in error: " + error.message);
                console.error('Firebase custom token sign-in error:', error); // DEBUG LOG
              });
          } else {
            showError("No Firebase token received from backend: " + (data.error || "Unknown error"));
            console.error('No Firebase token from backend:', data); // DEBUG LOG
          }
        })
        .catch(error => {
          showError("Error during LinkedIn authentication: " + error.message);
          console.error('Error during LinkedIn authentication fetch:', error); // DEBUG LOG
        });
      } else if (urlParams.get('error')) {
        showError("LinkedIn authentication error: " + urlParams.get('error_description') || urlParams.get('error'));
        console.error('LinkedIn OAuth error in URL:', urlParams.get('error_description') || urlParams.get('error')); // DEBUG LOG
      } else {
        showError("No LinkedIn authorization code found in URL.");
        console.warn('No LinkedIn authorization code found in URL.'); // DEBUG LOG
      }
    });
  </script>
</body>
</html>
