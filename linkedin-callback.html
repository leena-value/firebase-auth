<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Auth Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 5px; }
    #status { color: green; }
    #error { color: red; }
  </style>
</head>
<body>
  <h2>Firebase Auth Demo</h2>

  <!-- Email Signup/Login -->
  <div>
    <h3>Email Signup/Login</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <br/>
    <button onclick="signupEmail()">Sign Up</button>
    <button onclick="loginEmail()">Log In</button>
    <button onclick="logout()">Log Out</button>
  </div>

  <!-- Phone OTP Auth -->
  <div>
    <h3>Phone Signup/Login</h3>
    <input type="text" id="phone" placeholder="+1234567890" />
    <div id="recaptcha-container"></div>
    <button onclick="sendOTP()">Send OTP</button>
    <input type="text" id="otp" placeholder="Enter OTP" />
    <button onclick="verifyOTP()">Verify OTP</button>
  </div>

  <!-- LinkedIn Auth -->
  <div>
    <h3>LinkedIn Signup/Login</h3>
    <button onclick="loginWithLinkedIn()">Sign in with LinkedIn</button>
  </div>

  <div id="status"></div>
  <div id="error"></div>

  <!-- Firebase JS SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="./firebaseConfig.js"></script>
  <script>
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');

    function showStatus(msg) {
      statusDiv.textContent = msg;
      errorDiv.textContent = '';
    }

    function showError(msg) {
      errorDiv.textContent = msg;
      statusDiv.textContent = '';
    }

    // ✅ Email Signup
    function signupEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.createUserWithEmailAndPassword(email, pass)
        .then(user => showStatus("Signup successful: " + user.user.uid))
        .catch(err => showError("Signup error: " + err.message));
    }

    // ✅ Email Login
    function loginEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, pass)
        .then(user => showStatus("Login successful: " + user.user.uid))
        .catch(err => showError("Login error: " + err.message));
    }

    // ✅ Logout
    function logout() {
      auth.signOut()
        .then(() => showStatus("Logged out"))
        .catch(err => showError("Logout error: " + err.message));
    }

    // ✅ reCAPTCHA Setup (once)
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
      'size': 'normal',
      'callback': response => {
        showStatus("reCAPTCHA solved. You can now send OTP.");
      }
    });

    let confirmationResult;

    // ✅ Send OTP
    function sendOTP() {
      const phone = document.getElementById('phone').value;
      const appVerifier = window.recaptchaVerifier;
      auth.signInWithPhoneNumber(phone, appVerifier)
        .then(result => {
          confirmationResult = result;
          showStatus("OTP sent. Enter it below.");
        })
        .catch(err => showError("OTP send error: " + err.message));
    }

    // ✅ Verify OTP
    function verifyOTP() {
      const code = document.getElementById('otp').value;
      if (!confirmationResult) {
        showError("Send OTP first");
        return;
      }
      confirmationResult.confirm(code)
        .then(result => showStatus("Phone login success: " + result.user.uid))
        .catch(err => showError("OTP verify error: " + err.message));
    }

    // ✅ LinkedIn Login (initiates the OAuth flow)
    function loginWithLinkedIn() {
        const clientId = '86crgnew3xgywt'; // Replace with your actual Client ID
        const redirectUri = 'https://leena-value.github.io/firebase-auth/linkedin-callback.html'; // Ensure this matches your LinkedIn App settings
        const state = Math.random().toString(36).substring(2); // Generate a random state for CSRF protection

        // --- IMPORTANT CHANGE HERE ---
        // Use the new OIDC scopes: 'openid profile email'
        const scope = 'openid profile email'; // 'email' replaces 'r_emailaddress', 'profile' replaces 'r_liteprofile'

        // Store state in session storage to verify it later in the callback
        sessionStorage.setItem('linkedin_oauth_state', state);
        console.log('index.html: Stored state in sessionStorage:', state); // DEBUG LOG

        const linkedInAuthURL = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}&scope=${scope}`;
        window.location.href = linkedInAuthURL;
    }
  </script>
</body>
</html>
