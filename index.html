<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Auth Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 5px; }
    #status { color: green; }
    #error { color: red; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <h2>Firebase Auth Demo</h2>

  <!-- Email Auth Section -->
  <div>
    <h3>Email Signup/Login</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <br />
    <button onclick="signupEmail()">Sign Up</button>
    <button onclick="loginEmail()">Log In</button>
    <button onclick="logout()">Log Out</button>
    <button onclick="showForgotPassword()">Forgot Password?</button>
  </div>

  <!-- Email OTP Verification -->
  <div id="emailVerificationSection" class="hidden">
    <h3>Verify Your Email</h3>
    <p>An OTP has been sent to <span id="verificationEmailDisplay"></span>.</p>
    <input type="text" id="signupOtp" placeholder="Enter OTP" />
    <button onclick="verifySignupOtp()">Verify Email OTP</button>
    <button onclick="resendSignupOtp()">Resend OTP</button>
    <button onclick="changeEmailAddress()">Change Email</button>
  </div>

  <!-- Forgot Password Section -->
  <div id="forgotPasswordSection" class="hidden">
    <h3>Forgot Password</h3>
    <input type="email" id="forgotEmail" placeholder="Enter your email" />
    <button onclick="sendPasswordResetEmail()">Send Reset Email</button>

    <div id="otpVerificationSection" class="hidden">
      <input type="text" id="forgotOtp" placeholder="Enter OTP" />
      <button onclick="verifyPasswordResetOtp()">Verify OTP</button>
    </div>

    <div id="newPasswordSection" class="hidden">
      <input type="password" id="newPassword" placeholder="New Password" />
      <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" />
      <button onclick="resetPassword()">Reset Password</button>
    </div>

    <button onclick="hideForgotPassword()">Cancel</button>
  </div>

  <!-- LinkedIn Auth Section -->
  <div>
    <h3>LinkedIn Signup/Login</h3>
    <button onclick="loginWithLinkedIn()">Sign in with LinkedIn</button>
  </div>

  <!-- Status/Errors -->
  <div id="status"></div>
  <div id="error"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- App Config & Logic -->
  <script type="module">
    import { firebaseConfig, API_BASE_URL } from './firebaseConfig.js';

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    let currentSignupEmail = '';
    let passwordResetOobCode = '';

    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');
    const emailVerificationSection = document.getElementById('emailVerificationSection');
    const verificationEmailDisplay = document.getElementById('verificationEmailDisplay');
    const forgotPasswordSection = document.getElementById('forgotPasswordSection');
    const otpVerificationSection = document.getElementById('otpVerificationSection');
    const newPasswordSection = document.getElementById('newPasswordSection');

    function showStatus(msg) {
      statusDiv.textContent = msg;
      errorDiv.textContent = '';
    }

    function showError(msg) {
      errorDiv.textContent = msg;
      statusDiv.textContent = '';
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function isStrongPassword(password) {
      const minLength = 6;
      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumber = /[0-9]/.test(password);
      const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(password);
      return password.length >= minLength && hasUpperCase && hasLowerCase && hasNumber && hasSpecialChar;
    }

    function showEmailVerification(email) {
      emailVerificationSection.classList.remove('hidden');
      verificationEmailDisplay.textContent = email;
      document.getElementById('signupOtp').value = '';
      showStatus('');
      showError('');
    }

    function hideEmailVerification() {
      emailVerificationSection.classList.add('hidden');
      showStatus('');
      showError('');
    }

    function changeEmailAddress() {
      showStatus("Email verification cancelled. Please enter a new email.");
      hideEmailVerification();
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      currentSignupEmail = '';
    }

    function showForgotPassword() {
      forgotPasswordSection.classList.remove('hidden');
      otpVerificationSection.classList.add('hidden');
      newPasswordSection.classList.add('hidden');
      document.getElementById('forgotEmail').value = '';
      document.getElementById('forgotOtp').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
      showStatus('');
      showError('');
    }

    function hideForgotPassword() {
      forgotPasswordSection.classList.add('hidden');
      showStatus('');
      showError('');
    }

    function signupEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;

      if (!email || !pass) return showError("Please enter both email and password.");
      if (!isValidEmail(email)) return showError("Invalid email format.");
      if (!isStrongPassword(pass)) return showError("Password not strong enough.");

      auth.createUserWithEmailAndPassword(email, pass)
        .then(() => {
          currentSignupEmail = email;
          showStatus("Account created. Sending OTP...");
          sendSignupOtp(email);
        })
        .catch(err => {
          if (err.code === 'auth/email-already-in-use') {
            showError("Email already in use.");
          } else {
            showError("Signup error: " + err.message);
          }
        });
    }

    async function sendSignupOtp(email) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/send-email-otp/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await response.json();
        if (response.ok) {
          showStatus(data.message);
          showEmailVerification(email);
        } else {
          showError(data.error || 'Failed to send OTP.');
          auth.currentUser.delete().catch(() => {});
        }
      } catch {
        showError('Network/server error while sending OTP.');
        auth.currentUser.delete().catch(() => {});
      }
    }

    function resendSignupOtp() {
      if (currentSignupEmail) {
        showStatus("Resending OTP...");
        sendSignupOtp(currentSignupEmail);
      } else {
        showError("No email available. Please sign up again.");
      }
    }

    async function verifySignupOtp() {
      const otp = document.getElementById('signupOtp').value;
      if (!otp) return showError("Please enter the OTP.");
      if (!currentSignupEmail) return showError("Email not set. Please sign up again.");

      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/verify-email-otp/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentSignupEmail, otp })
        });

        const data = await response.json();
        if (response.ok) {
          showStatus(data.message + " You can now log in.");
          hideEmailVerification();
          currentSignupEmail = '';
        } else {
          showError(data.error || 'OTP verification failed.');
        }
      } catch {
        showError('Error verifying OTP.');
      }
    }

    function loginEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;

      if (!email || !pass) return showError("Please enter both email and password.");

      auth.signInWithEmailAndPassword(email, pass)
        .then(userCredential => {
          const user = userCredential.user;
          if (user.emailVerified) {
            showStatus("Login successful: " + user.uid);
          } else {
            showError("Verify your email before logging in.");
            user.sendEmailVerification();
            auth.signOut();
          }
        })
        .catch(err => {
          if (['auth/user-not-found', 'auth/wrong-password'].includes(err.code)) {
            showError("Invalid email or password.");
          } else {
            showError("Login error: " + err.message);
          }
        });
    }

    function logout() {
      auth.signOut()
        .then(() => showStatus("Logged out"))
        .catch(err => showError("Logout error: " + err.message));
    }

    function sendPasswordResetEmail() {
      const email = document.getElementById('forgotEmail').value;
      if (!email) return showError("Please enter your email.");
      if (!isValidEmail(email)) return showError("Invalid email.");

      auth.sendPasswordResetEmail(email)
        .then(() => showStatus("Password reset email sent to " + email))
        .catch(err => showError("Error: " + err.message));
    }

    function handlePasswordResetUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      const actionCode = urlParams.get('oobCode');

      if (mode === 'resetPassword' && actionCode) {
        passwordResetOobCode = actionCode;
        showStatus("Enter your new password below.");
        forgotPasswordSection.classList.remove('hidden');
        document.getElementById('forgotEmail').classList.add('hidden');
        document.querySelector('#forgotPasswordSection button[onclick="sendPasswordResetEmail()"]').classList.add('hidden');
        newPasswordSection.classList.remove('hidden');
      }
    }

    function resetPassword() {
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmNewPassword').value;

      if (!newPass || !confirmPass) return showError("Please fill both password fields.");
      if (newPass !== confirmPass) return showError("Passwords do not match.");
      if (!isStrongPassword(newPass)) return showError("Weak password.");

      auth.confirmPasswordReset(passwordResetOobCode, newPass)
        .then(() => {
          showStatus("Password changed successfully.");
          hideForgotPassword();
          passwordResetOobCode = '';
          history.replaceState({}, document.title, window.location.pathname);
        })
        .catch(err => showError("Error: " + err.message));
    }

    function loginWithLinkedIn() {
      const clientId = '86crgnew3xgywt';
      const redirectUri = 'https://leena-value.github.io/firebase-auth/linkedin-callback.html';
      const state = Math.random().toString(36).substring(2);
      const scope = 'openid profile email';

      sessionStorage.setItem('linkedin_oauth_state', state);
      const url = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}&scope=${scope}`;
      window.location.href = url;
    }

    // Register functions for inline onclick
    window.signupEmail = signupEmail;
    window.loginEmail = loginEmail;
    window.logout = logout;
    window.resendSignupOtp = resendSignupOtp;
    window.verifySignupOtp = verifySignupOtp;
    window.changeEmailAddress = changeEmailAddress;
    window.showForgotPassword = showForgotPassword;
    window.hideForgotPassword = hideForgotPassword;
    window.sendPasswordResetEmail = sendPasswordResetEmail;
    window.resetPassword = resetPassword;
    window.loginWithLinkedIn = loginWithLinkedIn;

    // Load time logic
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const linkedinAuthSuccess = urlParams.get('linkedin_auth_success');
      const userId = urlParams.get('uid');

      if (linkedinAuthSuccess === 'true' && userId) {
        showStatus("LinkedIn sign-in successful: " + userId);
        history.replaceState({}, document.title, window.location.pathname);
      }

      handlePasswordResetUrl();
    });
  </script>
</body>
</html>
