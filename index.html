<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Auth Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 5px; }
    #status { color: green; }
    #error { color: red; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <h2>Firebase Auth Demo</h2>

  <!-- Email Auth Section -->
  <div>
    <h3>Email Signup/Login</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <br />
    <button onclick="signupEmail()">Sign Up</button>
    <button onclick="loginEmail()">Log In</button>
    <button onclick="logout()">Log Out</button>
    <button onclick="showForgotPassword()">Forgot Password?</button>
  </div>

  <!-- Email OTP Verification -->
  <div id="emailVerificationSection" class="hidden">
    <h3>Verify Your Email</h3>
    <p>An OTP has been sent to <span id="verificationEmailDisplay"></span>.</p>
    <input type="text" id="signupOtp" placeholder="Enter OTP" />
    <button onclick="verifySignupOtp()">Verify Email OTP</button>
    <button onclick="resendSignupOtp()">Resend OTP</button>
    <button onclick="changeEmailAddress()">Change Email</button>
  </div>

  <div id="companyEmailSection" class="hidden">
    <h3>Company Email Required</h3>
    <p id="companyEmailMessage"></p>
    <input type="email" id="companyEmailInput" placeholder="Enter your work email" />
    <button onclick="updateCompanyEmail()">Submit and Verify</button>
  </div>

  <!-- Forgot Password Section -->
  <div id="forgotPasswordSection" class="hidden">
    <h3>Forgot Password</h3>
    <input type="email" id="forgotEmail" placeholder="Enter your email" />
    <button onclick="sendPasswordResetEmail()">Send Reset Email</button>

    <div id="otpVerificationSection" class="hidden">
      <input type="text" id="forgotOtp" placeholder="Enter OTP" />
      <button onclick="verifyPasswordResetOtp()">Verify OTP</button>
    </div>

    <div id="newPasswordSection" class="hidden">
      <input type="password" id="newPassword" placeholder="New Password" />
      <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" />
      <button onclick="resetPassword()">Reset Password</button>
    </div>

    <button onclick="hideForgotPassword()">Cancel</button>
  </div>

  <!-- LinkedIn Auth Section -->
  <div>
    <h3>LinkedIn Signup/Login</h3>
    <button onclick="loginWithLinkedIn()">Sign in with LinkedIn</button>
  </div>

  <!-- Status/Errors -->
  <div id="status"></div>
  <div id="error"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

  <!-- App Config & Logic -->
  <script type="module">
    import { firebaseConfig, API_BASE_URL } from './firebaseConfig.js';

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    let currentSignupEmail = '';
    let passwordResetOobCode = '';

    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');
    const emailVerificationSection = document.getElementById('emailVerificationSection');
    const verificationEmailDisplay = document.getElementById('verificationEmailDisplay');
    const forgotPasswordSection = document.getElementById('forgotPasswordSection');
    const otpVerificationSection = document.getElementById('otpVerificationSection');
    const newPasswordSection = document.getElementById('newPasswordSection');
    const companyEmailSection = document.getElementById('companyEmailSection');
    const companyEmailMessage = document.getElementById('companyEmailMessage');

    function showStatus(msg) {
      statusDiv.textContent = msg;
      errorDiv.textContent = '';
    }

    function showError(msg) {
      errorDiv.textContent = msg;
      statusDiv.textContent = '';
    }

    function showCompanyEmailPrompt(message) {
    companyEmailSection.classList.remove('hidden');
    companyEmailMessage.textContent = message;
    hideEmailVerification(); // Hide other prompts
}

function hideCompanyEmailPrompt() {
    companyEmailSection.classList.add('hidden');
}

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function isStrongPassword(password) {
  const minLength = 8;
  const maxLength = 16;
  const hasUpperCase = /[A-Z]/.test(password);
  const hasLowerCase = /[a-z]/.test(password);
  const hasNumber = /[0-9]/.test(password);
  const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(password);

  const commonPatterns = ["123456", "password", "qwerty", "abc123", "111111"];

  const isCommon = commonPatterns.some(pattern => password.toLowerCase().includes(pattern));

  return (
    password.length >= minLength &&
    password.length <= maxLength &&
    hasUpperCase &&
    hasLowerCase &&
    hasNumber &&
    hasSpecialChar &&
    !isCommon
  );
}

   
    function showEmailVerification(email) {
      emailVerificationSection.classList.remove('hidden');
      verificationEmailDisplay.textContent = email;
      document.getElementById('signupOtp').value = '';
      showStatus('');
      showError('');
    }

    function hideEmailVerification() {
      emailVerificationSection.classList.add('hidden');
      showStatus('');
      showError('');
    }

    function changeEmailAddress() {
      showStatus("Email verification cancelled. Please enter a new email.");
      hideEmailVerification();
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      currentSignupEmail = '';
    }

    function showForgotPassword() {
      forgotPasswordSection.classList.remove('hidden');
      otpVerificationSection.classList.add('hidden');
      newPasswordSection.classList.add('hidden');
      document.getElementById('forgotEmail').value = '';
      document.getElementById('forgotOtp').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
      showStatus('');
      showError('');
    }

    function hideForgotPassword() {
      forgotPasswordSection.classList.add('hidden');
      showStatus('');
      showError('');
    }

    function signupEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;

      if (!email || !pass) return showError("Please enter both email and password.");
      if (!isValidEmail(email)) return showError("Invalid email format.");
      if (!isStrongPassword(pass)) return showError("Please enter correct password format.");

      auth.createUserWithEmailAndPassword(email, pass)
        .then(() => {
          currentSignupEmail = email;
          showStatus("Account created. Sending OTP...");
          sendSignupOtp(email);
        })
        .catch(err => {
          if (err.code === 'auth/email-already-in-use') {
            showError("Email already in use.");
          } else {
            showError("Signup error: " + err.message);
          }
        });
    }

    async function sendSignupOtp(email) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/send-email-otp/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await response.json();
        if (response.ok) {
          showStatus(data.message);
          showEmailVerification(email);
        } else {
          showError(data.error || 'Failed to send OTP.');
          auth.currentUser.delete().catch(() => {});
        }
      } catch {
        showError('Network/server error while sending OTP.');
        auth.currentUser.delete().catch(() => {});
      }
    }

    function resendSignupOtp() {
      if (currentSignupEmail) {
        showStatus("Resending OTP...");
        sendSignupOtp(currentSignupEmail);
      } else {
        showError("No email available. Please sign up again.");
      }
    }

    async function verifySignupOtp() {
    const otp = document.getElementById('signupOtp').value;
    if (!otp) return showError("Please enter the OTP.");
    if (!currentSignupEmail) return showError("Email not set. Please sign up again.");

    try {
        const response = await fetch(`${API_BASE_URL}/api/auth/verify-email-otp/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentSignupEmail, otp })
        });

        const data = await response.json();
        if (response.ok) {
            // --- NEW LOGIC ---
            if (data.status === 'company_email_required') {
                // The backend requires a company email. Prompt the user.
                showStatus(data.message); // Show the informational message
                // The user is not fully logged in yet, but we need to sign them in to proceed
                // to the "update email" step. First, prompt for login.
                showError("Please log in with your original credentials to provide a company email.");
                hideEmailVerification();
            } else {
                // Success! User has a company domain or is joining an org.
                showStatus(data.message + " You can now log in.");
                hideEmailVerification();
            }
            currentSignupEmail = ''; // Clear the email
        } else {
            showError(data.error || 'OTP verification failed.');
        }
    } catch {
        showError('Error verifying OTP.');
    }
}

    function loginEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;

      if (!email || !pass) return showError("Please enter both email and password.");

      auth.signInWithEmailAndPassword(email, pass)
        .then(userCredential => {
          const user = userCredential.user;
          if (user.emailVerified) {
            showStatus("Login successful: " + user.uid);
          } else {
            showError("Verify your email before logging in.");
            user.sendEmailVerification();
            auth.signOut();
          }
        })
        .catch(err => {
          if (['auth/user-not-found', 'auth/wrong-password'].includes(err.code)) {
            showError("Invalid email or password.");
          } else {
            showError("Login error: " + err.message);
          }
        });
    }

    function logout() {
      auth.signOut()
        .then(() => showStatus("Logged out"))
        .catch(err => showError("Logout error: " + err.message));
    }

    function sendPasswordResetEmail() {
      const email = document.getElementById('forgotEmail').value;
      if (!email) return showError("Please enter your email.");
      if (!isValidEmail(email)) return showError("Invalid email.");

      auth.sendPasswordResetEmail(email)
        .then(() => showStatus("Password reset email sent to " + email))
        .catch(err => showError("Error: " + err.message));
    }

    function handlePasswordResetUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      const actionCode = urlParams.get('oobCode');

      if (mode === 'resetPassword' && actionCode) {
        passwordResetOobCode = actionCode;
        showStatus("Enter your new password below.");
        forgotPasswordSection.classList.remove('hidden');
        document.getElementById('forgotEmail').classList.add('hidden');
        document.querySelector('#forgotPasswordSection button[onclick="sendPasswordResetEmail()"]').classList.add('hidden');
        newPasswordSection.classList.remove('hidden');
      }
    }

    function resetPassword() {
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmNewPassword').value;

      if (!newPass || !confirmPass) return showError("Please fill both password fields.");
      if (newPass !== confirmPass) return showError("Passwords do not match.");
      if (!isStrongPassword(newPass)) return showError("Weak password.");

      auth.confirmPasswordReset(passwordResetOobCode, newPass)
        .then(() => {
          showStatus("Password changed successfully.");
          hideForgotPassword();
          passwordResetOobCode = '';
          history.replaceState({}, document.title, window.location.pathname);
        })
        .catch(err => showError("Error: " + err.message));
    }

    function loginWithLinkedIn() {
      const clientId = '86crgnew3xgywt';
      const redirectUri = 'https://leena-value.github.io/firebase-auth/linkedin-callback.html';
      const state = Math.random().toString(36).substring(2);
      const scope = 'openid profile email';

      sessionStorage.setItem('linkedin_oauth_state', state);
      const url = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}&scope=${scope}`;
      window.location.href = url;
    }

    async function updateCompanyEmail() {
    const newEmail = document.getElementById('companyEmailInput').value;
    if (!isValidEmail(newEmail)) {
        return showError("Please enter a valid email address.");
    }

    const user = auth.currentUser;
    if (!user) {
        return showError("You are not logged in. Please log in first.");
    }

    showStatus("Updating email and checking organization...");
    try {
        const idToken = await user.getIdToken(true); // Get fresh token for backend auth

        const response = await fetch(`${API_BASE_URL}/api/auth/update-company-email/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${idToken}` // Send token for authentication
            },
            body: JSON.stringify({ email: newEmail })
        });

        const data = await response.json();
        if (response.ok) {
            showStatus(data.message);
            hideCompanyEmailPrompt();
            // The backend sent a new OTP. Show the verification screen again, for the new email.
            currentSignupEmail = newEmail;
            showEmailVerification(newEmail);
        } else {
            showError(data.error || "Failed to update email.");
        }
    } catch (error) {
        showError("An error occurred: " + error.message);
    }
}

    // Register functions for inline onclick
    window.signupEmail = signupEmail;
    window.loginEmail = loginEmail;
    window.logout = logout;
    window.resendSignupOtp = resendSignupOtp;
    window.verifySignupOtp = verifySignupOtp;
    window.changeEmailAddress = changeEmailAddress;
    window.showForgotPassword = showForgotPassword;
    window.hideForgotPassword = hideForgotPassword;
    window.sendPasswordResetEmail = sendPasswordResetEmail;
    window.resetPassword = resetPassword;
    window.loginWithLinkedIn = loginWithLinkedIn;
    window.updateCompanyEmail = updateCompanyEmail;

    // Load time logic
    window.addEventListener('DOMContentLoaded', () => {
    // Check for state from linkedin-callback
    const nextAction = sessionStorage.getItem('next_action');
    if (nextAction === 'prompt_company_email') {
        const message = sessionStorage.getItem('prompt_message');
        showCompanyEmailPrompt(message);
        // Clean up session storage so it doesn't trigger again
        sessionStorage.removeItem('next_action');
        sessionStorage.removeItem('prompt_message');
    }

    // This part remains the same
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('linkedin_auth_success') === 'true' && !nextAction) {
        const userId = sessionStorage.getItem('firebase_uid');
        showStatus("LinkedIn sign-in successful: " + userId);
        history.replaceState({}, document.title, window.location.pathname);
        sessionStorage.removeItem('firebase_uid');
    }
    
    handlePasswordResetUrl();
});
  </script>
</body>
</html>
