<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Auth Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { margin: 5px; padding: 5px; }
    #status { color: green; }
    #error { color: red; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <h2>Firebase Auth Demo</h2>

  <!-- Email Auth Section -->
  <div>
    <h3>Email Signup/Login</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <br />
    <button onclick="signupEmail()">Sign Up</button>
    <button onclick="loginEmail()">Log In</button>
    <button onclick="logout()">Log Out</button>
    <button onclick="showForgotPassword()">Forgot Password?</button>
  </div>

  <!-- Email OTP Verification -->
  <div id="emailVerificationSection" class="hidden">
    <h3>Verify Your Email</h3>
    <p>An OTP has been sent to <span id="verificationEmailDisplay"></span>.</p>
    <input type="text" id="signupOtp" placeholder="Enter OTP" />
    <button onclick="verifySignupOtp()">Verify Email OTP</button>
    <button onclick="resendSignupOtp()">Resend OTP</button>
    <button onclick="changeEmailAddress()">Change Email</button>
  </div>

  <div id="companyEmailSection" class="hidden">
    <h3>Company Email Required</h3>
    <p id="companyEmailMessage"></p>
    <input type="email" id="companyEmailInput" placeholder="Enter your work email" />
    <button onclick="updateCompanyEmail()">Submit and Verify</button>
  </div>

  <!-- Forgot Password Section -->
  <div id="forgotPasswordSection" class="hidden">
    <h3>Forgot Password</h3>
    <input type="email" id="forgotEmail" placeholder="Enter your email" />
    <button onclick="sendPasswordResetEmail()">Send Reset Email</button>

    <div id="otpVerificationSection" class="hidden">
      <input type="text" id="forgotOtp" placeholder="Enter OTP" />
      <button onclick="verifyPasswordResetOtp()">Verify OTP</button>
    </div>

    <div id="newPasswordSection" class="hidden">
      <input type="password" id="newPassword" placeholder="New Password" />
      <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" />
      <button onclick="resetPassword()">Reset Password</button>
    </div>

    <button onclick="hideForgotPassword()">Cancel</button>
  </div>

  <div>
    <h3>LinkedIn Signup/Login</h3>
    <!-- ADD THE ID HERE -->
    <button id="loginWithLinkedInBtn" onclick="loginWithLinkedIn()">Sign in with LinkedIn</button>
</div>

  <!-- Onboarding UI Sections -->
  <div id="onboardingSection" class="hidden">
      <hr>
      <h2>Onboarding</h2>

      <!-- State: Needs to create an organization -->
      <div id="createOrgSection" class="hidden">
          <h3>Create Your Organization</h3>
          <p>We couldn't find an organization for your domain (<span id="orgDomain"></span>). Let's create one!</p>
          <input type="text" id="orgNameInput" placeholder="Organization Name">
          <button onclick="createOrganization()">Create Organization</button>
      </div>

      <!-- State: Needs to join an existing organization -->
      <div id="joinOrgSection" class="hidden">
          <h3>Join <span id="joinOrgName"></span></h3>
          <p>Select a workspace to join:</p>
          <div id="workspacesList"></div>
      </div>
      
      <!-- State: Needs to create a workspace -->
      <div id="createWorkspaceSection" class="hidden">
          <h3>Create Your First Workspace</h3>
          <input type="text" id="workspaceNameInput" placeholder="Workspace Name">
          <button onclick="createWorkspace()">Create Workspace</button>
      </div>
  </div>


  <!-- Status/Errors -->
  <div id="status"></div>
  <div id="error"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script type="module">
    import { firebaseConfig, API_BASE_URL } from './firebaseConfig.js';

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Cleaned up global variables
    let currentSignupEmail = '';
    let forgotPasswordEmail = '';

    // DOM Element variables are correct
    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');
    const emailVerificationSection = document.getElementById('emailVerificationSection');
    const verificationEmailDisplay = document.getElementById('verificationEmailDisplay');
    const forgotPasswordSection = document.getElementById('forgotPasswordSection');
    // Note: The child div for OTP needs its own ID for clarity
    const forgotOtpVerificationSection = forgotPasswordSection.querySelector('#otpVerificationSection');
    const newPasswordSection = document.getElementById('newPasswordSection');
    const companyEmailSection = document.getElementById('companyEmailSection');
    const companyEmailMessage = document.getElementById('companyEmailMessage');
    const onboardingSection = document.getElementById('onboardingSection');
    const createOrgSection = document.getElementById('createOrgSection');
    const joinOrgSection = document.getElementById('joinOrgSection');
    const createWorkspaceSection = document.getElementById('createWorkspaceSection');

    // --- All helper and primary functions ---
    // (These are all correct as you wrote them)

    function showStatus(msg) {
      statusDiv.textContent = msg;
      errorDiv.textContent = '';
    }

    function showError(msg) {
      errorDiv.textContent = msg;
      statusDiv.textContent = '';
    }

    function showCompanyEmailPrompt(message) {
        companyEmailSection.classList.remove('hidden');
        companyEmailMessage.textContent = message;
        hideEmailVerification();
    }

    function hideCompanyEmailPrompt() {
        companyEmailSection.classList.add('hidden');
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function isStrongPassword(password) {
        const minLength = 8;
        const maxLength = 16;
        const hasUpperCase = /[A-Z]/.test(password);
        const hasLowerCase = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSpecialChar = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/.test(password);
        const commonPatterns = ["123456", "password", "qwerty", "abc123", "111111"];
        const isCommon = commonPatterns.some(pattern => password.toLowerCase().includes(pattern));
        return (
            password.length >= minLength &&
            password.length <= maxLength &&
            hasUpperCase && hasLowerCase &&
            hasNumber && hasSpecialChar && !isCommon
        );
    }
   
    function showEmailVerification(email) {
      emailVerificationSection.classList.remove('hidden');
      verificationEmailDisplay.textContent = email;
      document.getElementById('signupOtp').value = '';
      showStatus('');
      showError('');
    }

    function hideEmailVerification() {
      emailVerificationSection.classList.add('hidden');
      showStatus('');
      showError('');
    }

    function changeEmailAddress() {
      showStatus("Email verification cancelled. Please enter a new email.");
      hideEmailVerification();
      document.getElementById('email').value = '';
      document.getElementById('password').value = '';
      currentSignupEmail = '';
    }

    function showForgotPassword() {
      forgotPasswordSection.classList.remove('hidden');
      forgotOtpVerificationSection.classList.add('hidden');
      newPasswordSection.classList.add('hidden');
      document.getElementById('forgotEmail').value = '';
      document.getElementById('forgotOtp').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmNewPassword').value = '';
      showStatus('');
      showError('');
    }

    function hideForgotPassword() {
      forgotPasswordSection.classList.add('hidden');
      showStatus('');
      showError('');
    }

    function signupEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      if (!email || !pass) return showError("Please enter both email and password.");
      if (!isValidEmail(email)) return showError("Invalid email format.");
      if (!isStrongPassword(pass)) return showError("Password does not meet complexity requirements.");
      auth.createUserWithEmailAndPassword(email, pass)
        .then(() => {
          currentSignupEmail = email;
          showStatus("Account created. Sending OTP...");
          sendSignupOtp(email);
        })
        .catch(err => {
          if (err.code === 'auth/email-already-in-use') {
            showError("Email already in use.");
          } else {
            showError("Signup error: " + err.message);
          }
        });
    }

    async function sendSignupOtp(email) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/auth/send-email-otp/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await response.json();
        if (response.ok) {
          showStatus(data.message);
          showEmailVerification(email);
        } else {
          showError(data.error || 'Failed to send OTP.');
          auth.currentUser?.delete().catch(() => {});
        }
      } catch {
        showError('Network/server error while sending OTP.');
        auth.currentUser?.delete().catch(() => {});
      }
    }

    function resendSignupOtp() {
      if (currentSignupEmail) {
        showStatus("Resending OTP...");
        sendSignupOtp(currentSignupEmail);
      } else {
        showError("No email available. Please sign up again.");
      }
    }

    async function verifySignupOtp() {
        const otp = document.getElementById('signupOtp').value;
        if (!otp) return showError("Please enter the OTP.");
        if (!currentSignupEmail) return showError("Email not set. Please sign up again.");
        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/verify-email-otp/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: currentSignupEmail, otp })
            });
            const data = await response.json();
            if (response.ok) {
                showStatus(data.message);
                hideEmailVerification();
                currentSignupEmail = ''; 
            } else {
                showError(data.error || 'OTP verification failed.');
            }
        } catch {
            showError('Error verifying OTP.');
        }
    }

   // ...existing code...
async function handleSuccessfulAuth() {
    console.log("handleSuccessfulAuth: called");
    showStatus("Authentication successful. Checking your onboarding status...");
    console.log("handleSuccessfulAuth: showStatus called");
    document.querySelector('div:has(> #email)').classList.add('hidden');
    console.log("handleSuccessfulAuth: email div hidden");
    document.querySelector('div:has(> #loginWithLinkedInBtn)').classList.add('hidden');
    console.log("handleSuccessfulAuth: LinkedIn button div hidden");
    hideEmailVerification();
    console.log("handleSuccessfulAuth: hideEmailVerification called");
    hideCompanyEmailPrompt();
    console.log("handleSuccessfulAuth: hideCompanyEmailPrompt called");
    try {
        const user = auth.currentUser;
        console.log("handleSuccessfulAuth: got currentUser", user);
        if (!user) {
            console.log("handleSuccessfulAuth: user not found");
            return showError("Not logged in. Cannot check status.");
        }
        const idToken = await user.getIdToken(true);
        console.log("handleSuccessfulAuth: got idToken", idToken);
        console.log("Checking onboarding status for user:", user.uid);

        console.log("this is token", idToken);
        const response = await fetch(`${API_BASE_URL}/api/organization/onboarding-status/`, {
            headers: { 'Authorization': `Bearer ${idToken}` }
        });
        console.log("handleSuccessfulAuth: fetched onboarding-status", typeof(response));
        console.log("handleSuccessfulAuth: response status", response.body.getReader().read().then(({ done, value }) => {
            console.log("handleSuccessfulAuth: response body read", done, value);
        }));
        const data = await response.json();
        console.log("handleSuccessfulAuth: fetched onboarding-status");
        console.log("handleSuccessfulAuth: onboarding-status response data", data);
        if (!response.ok) {
            console.log("handleSuccessfulAuth: response not ok");
            throw new Error(data.error || 'Failed to get onboarding status.');
        }
        
        onboardingSection.classList.remove('hidden');
        console.log("handleSuccessfulAuth: onboardingSection shown");
        createOrgSection.classList.add('hidden');
        console.log("handleSuccessfulAuth: createOrgSection hidden");
        joinOrgSection.classList.add('hidden');
        console.log("handleSuccessfulAuth: joinOrgSection hidden");
        createWorkspaceSection.classList.add('hidden');
        console.log("handleSuccessfulAuth: createWorkspaceSection hidden");
        
        switch (data.status) {
            case 'ONBOARDED':
                console.log("handleSuccessfulAuth: status ONBOARDED");
                showStatus(`Welcome back! You are onboarded to ${data.organization.name}. Redirecting to dashboard...`);
                // window.location.href = '/dashboard';
                break;
            case 'NEEDS_ORGANIZATION':
                console.log("handleSuccessfulAuth: status NEEDS_ORGANIZATION");
                showStatus("Let's get you set up with an organization.");
                createOrgSection.classList.remove('hidden');
                console.log("handleSuccessfulAuth: createOrgSection shown");
                document.getElementById('orgDomain').textContent = data.domain || 'your company';
                console.log("handleSuccessfulAuth: orgDomain set");
                break;
            case 'ORGANIZATION_EXISTS':
                console.log("handleSuccessfulAuth: status ORGANIZATION_EXISTS");
                showStatus(`Your company, ${data.organization_name}, is already on the platform.`);
                joinOrgSection.classList.remove('hidden');
                console.log("handleSuccessfulAuth: joinOrgSection shown");
                document.getElementById('joinOrgName').textContent = data.organization_name;
                console.log("handleSuccessfulAuth: joinOrgName set");
                const list = document.getElementById('workspacesList');
                list.innerHTML = data.workspaces.length ? '' : '<p>No workspaces available to join. Contact an admin.</p>';
                console.log("handleSuccessfulAuth: workspacesList cleared or message set");
                data.workspaces.forEach(ws => {
                    list.innerHTML += `<p>${ws.name} - <i>Status: ${ws.join_status || 'Not Requested'}</i> <button>Request to Join</button></p>`;
                    console.log("handleSuccessfulAuth: workspace listed", ws);
                });
                break;
            default:
                console.log("handleSuccessfulAuth: unknown status", data.status);
                showError("Received an unknown onboarding status.");
        }
    } catch (err) {
        console.log("handleSuccessfulAuth: error", err);
        showError("Error checking onboarding status: " + err.message);
    }
}
// ...existing

    function loginEmail() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      if (!email || !pass) return showError("Please enter both email and password.");
      auth.signInWithEmailAndPassword(email, pass)
        .then(userCredential => {
          const user = userCredential.user;
          // IMPORTANT: Firebase automatically checks verification status
          // The emailVerified property might not be instantly updated after our OTP check.
          // We will trust our backend and proceed directly to the router.
          handleSuccessfulAuth();
        })
        .catch(err => {
          if (['auth/user-not-found', 'auth/wrong-password'].includes(err.code)) {
            showError("Invalid email or password.");
          } else {
            showError("Login error: " + err.message);
          }
        });
    }

    function logout() {
      auth.signOut()
        .then(() => {
            showStatus("Logged out");
            // Here you would typically reload the page or show the login forms again
            window.location.reload();
        })
        .catch(err => showError("Logout error: " + err.message));
    }

    // --- NEW OTP-BASED PASSWORD RESET FUNCTIONS ---
    async function sendPasswordResetOtp() {
        const email = document.getElementById('forgotEmail').value;
        if (!email) return showError("Please enter your email.");
        if (!isValidEmail(email)) return showError("Invalid email.");
        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/send-password-reset-otp/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const data = await response.json();
            if (response.ok) {
                showStatus(data.message);
                forgotPasswordEmail = email;
                forgotOtpVerificationSection.classList.remove('hidden');
            } else {
                showError(data.error || "Failed to send OTP.");
            }
        } catch {
            showError("Network error.");
        }
    }

    async function verifyPasswordResetOtp() {
        const otp = document.getElementById('forgotOtp').value;
        if (!otp) return showError("Please enter OTP.");
        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/verify-password-reset-otp/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: forgotPasswordEmail, otp })
            });
            const data = await response.json();
            if (response.ok) {
                showStatus(data.message);
                forgotOtpVerificationSection.classList.add('hidden');
                newPasswordSection.classList.remove('hidden');
            } else {
                showError(data.error || "Invalid OTP.");
            }
        } catch {
            showError("Network error.");
        }
    }

    async function resetPassword() {
        const newPass = document.getElementById('newPassword').value;
        const confirmPass = document.getElementById('confirmNewPassword').value;
        const otp = document.getElementById('forgotOtp').value;
        if (!newPass || !confirmPass) return showError("Please fill both password fields.");
        if (newPass !== confirmPass) return showError("Passwords do not match.");
        if (!isStrongPassword(newPass)) return showError("Weak password.");
        try {
            const response = await fetch(`${API_BASE_URL}/api/auth/reset-password-with-otp/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: forgotPasswordEmail, otp, password: newPass })
            });
            const data = await response.json();
            if (response.ok) {
                showStatus("Password changed successfully. You can now log in.");
                hideForgotPassword();
                forgotPasswordEmail = '';
            } else {
                showError(data.error || "Failed to reset password.");
            }
        } catch {
            showError("Network error.");
        }
    }

    function loginWithLinkedIn() {
      const clientId = '86crgnew3xgywt';
      const redirectUri = 'https://leena-value.github.io/firebase-auth/linkedin-callback.html';
      const state = Math.random().toString(36).substring(2);
      const scope = 'openid profile email';
      sessionStorage.setItem('linkedin_oauth_state', state);
      const url = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${clientId}&redirect_uri=${redirectUri}&state=${state}&scope=${scope}`;
      window.location.href = url;
    }

    async function updateCompanyEmail() {
        const newEmail = document.getElementById('companyEmailInput').value;
        if (!isValidEmail(newEmail)) return showError("Please enter a valid email address.");
        const user = auth.currentUser;
        if (!user) return showError("You are not logged in. Please log in first.");
        showStatus("Updating email and checking organization...");
        try {
            const idToken = await user.getIdToken(true);
            const response = await fetch(`${API_BASE_URL}/api/auth/update-company-email/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`
                },
                body: JSON.stringify({ email: newEmail })
            });
            const data = await response.json();
            if (response.ok) {
                showStatus(data.message);
                hideCompanyEmailPrompt();
                currentSignupEmail = newEmail;
                showEmailVerification(newEmail);
            } else {
                showError(data.error || "Failed to update email.");
            }
        } catch (error) {
            showError("An error occurred: " + error.message);
        }
    }

    // --- CLEANED UP GLOBAL REGISTRATIONS ---
    window.signupEmail = signupEmail;
    window.loginEmail = loginEmail;
    window.logout = logout;
    window.resendSignupOtp = resendSignupOtp;
    window.verifySignupOtp = verifySignupOtp;
    window.changeEmailAddress = changeEmailAddress;
    window.showForgotPassword = showForgotPassword;
    window.hideForgotPassword = hideForgotPassword;
    window.loginWithLinkedIn = loginWithLinkedIn;
    window.updateCompanyEmail = updateCompanyEmail;
    // Register the NEW password reset functions
    window.sendPasswordResetEmail = sendPasswordResetOtp;
    window.verifyPasswordResetOtp = verifyPasswordResetOtp;
    window.resetPassword = resetPassword;

    // --- CLEANED UP LOAD TIME LOGIC ---
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.get('linkedin_auth_success') === 'true') {
            history.replaceState({}, document.title, window.location.pathname);
            const unsubscribe = auth.onAuthStateChanged(user => {
                if (user) {
                    handleSuccessfulAuth();
                    unsubscribe();
                }
            });
        }
    });

  </script>
</body>
</html>
  
</body>
</html>
